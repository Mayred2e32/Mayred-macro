# Исправление стабильности воспроизведения движения камеры в макросе

## Проблема

При воспроизведении записанного макроса движение камеры (правая кнопка мыши + перетаскивание в Roblox) воспроизводилось неточно:
- Иногда движение камеры было слишком велико
- Иногда движение камеры было недостаточно
- Не соответствовало исходной записи
- WASD и стандартные движения мыши работали идеально

## Анализ причин

### Основная ошибка: неправильное отслеживание центра для дельта-расчета

В исходном коде:
1. При нажатии ПКМ устанавливалось `rmb_center = (x, y)` в позицию нажатия
2. При каждом движении вычислялся `dx = (x - rmb_center[0]) * CAMERA_GAIN`
3. **ПРОБЛЕМА**: `rmb_center` никогда не обновлялся после первого нажатия

### Пример неправильного поведения

Предположим, запись:
1. Нажать ПКМ в (100, 100)
2. Переместиться в (110, 110) → дельта должна быть (10, 10)
3. Переместиться в (120, 120) → дельта должна быть (10, 10)

**Исходное поведение (НЕПРАВИЛЬНОЕ):**
- Нажать ПКМ в (100, 100) → rmb_center = (100, 100)
- Двиг в (110, 110) → dx = 10 * 0.7 = 7
- Двиг в (120, 120) → dx = 20 * 0.7 = 14 ❌ (должно быть 7!)

Вторая дельта получается в 2 раза больше, потому что она рассчитывается от исходного центра (100), а не от промежуточной позиции (110).

## Реализованное исправление

### 1. Обновление rmb_center после каждого движения

```python
# КРИТИЧНО: обновляем центр на новую позицию после каждого движения
# Это заставляет следующее движение быть инкрементальным от этой позиции
rmb_center = (x, y)
```

Теперь каждая дельта рассчитывается от предыдущей позиции, обеспечивая правильное инкрементальное движение.

### 2. Изменение CAMERA_GAIN

- **Было:** `CAMERA_GAIN = 0.7` (70%)
- **Стало:** `CAMERA_GAIN = 1.0` (100%)

Причина: При правильной инкрементальной дельта-системе множитель должен быть 1.0 для точного воспроизведения. Если нужна чувствительность, её можно отрегулировать позже.

### 3. Изменение MIN_STEP_THRESHOLD

- **Было:** `MIN_STEP_THRESHOLD = 1`
- **Стало:** `MIN_STEP_THRESHOLD = 0`

Причина: Даже маленькие движения (0-1 пиксель) должны быть обработаны для точного воспроизведения.

## Добавленное логирование для отладки

### Переменная DEBUG_CAMERA_MOVEMENT

```python
DEBUG_CAMERA_MOVEMENT = True  # Детальное логирование движений камеры
```

Можно отключить, установив `False` для продакшена.

### Логи при записи

- `[REC DEBUG] RMB pressed at (x, y)` - нажатие ПКМ
- `[REC DEBUG] RMB released at (x, y)` - отпускание ПКМ
- `[REC DEBUG] Mouse move #N: (x, y)` - движение мыши (каждое 5-е событие)

### Логи при воспроизведении

- `[CAM DEBUG] Initial mouse_pos: (x, y)` - начальная позиция
- `[CAM DEBUG] RMB pressed at: (x, y)` - нажатие ПКМ
- `[CAM DEBUG] RMB move: pos(x,y) center(cx,cy) delta(dx,dy)` - движение при зажатой ПКМ
- `[CAM DEBUG] RMB released at: (x, y)` - отпускание ПКМ
- `[CAM DEBUG] Scroll: dx=..., dy=...` - прокрутка

## Критические улучшения

| Характеристика | До исправления | После исправления |
|---|---|---|
| Точность дельта-расчета | ❌ Накопительная ошибка | ✅ Инкрементальная |
| Множитель чувствительности | 0.7 (70%) | 1.0 (100%, точно) |
| Минимальный порог движения | 1 пиксель | 0 пикселей |
| Отслеживание центра | ❌ Фиксированное от нажатия | ✅ Обновляется каждый кадр |
| Логирование | Отсутствует | ✅ Подробное для отладки |

## Как использовать

### Включение отладки

```python
DEBUG_CAMERA_MOVEMENT = True
```

Логи появятся в окне "Лог выполнения" при записи и воспроизведении.

### Регулировка чувствительности

Если нужна иная чувствительность, измените `CAMERA_GAIN`:
- `0.5` - половинная чувствительность
- `1.0` - точное воспроизведение
- `2.0` - двойная чувствительность

## Тестирование

1. Запишите простое движение камеры:
   - Нажмите правую кнопку мыши
   - Переместитесь на несколько пикселей (например, 50 пикселей вправо)
   - Отпустите кнопку

2. Включите DEBUG_CAMERA_MOVEMENT = True

3. Воспроизведите макрос

4. Проверьте, что логи показывают правильные инкрементальные дельты

## Резюме

Ключевая ошибка была в отслеживании центра при зажатой ПКМ. Вместо накопительного расчета дельты от исходной позиции, теперь используется инкрементальный расчет от текущей позиции. Это обеспечивает точное и стабильное воспроизведение движений камеры.
