# ИНСТРУКЦИЯ ПО ТЕСТИРОВАНИЮ ИСПРАВЛЕНИЙ RMB DRAG

## КРИТИЧЕСКИЕ ИЗМЕНЕНИЯ:

### 1. ПОЛНАЯ ЗАМЕНА ФУНКЦИИ send_relative_line()
- **Старая проблема**: Сложная логика разбиения на шаги с SendInput
- **Новое решение**: Прямая отправка через mouse_event API с маленькими шагами и задержками
- **Почему это должно работать**: mouse_event - старый, но надежный API, который лучше поддерживается играми

### 2. МАКСИМАЛЬНОЕ ЛОГИРОВАНИЕ
Добавлено детальное логирование ВСЕХ этапов:
- Каждый вызов send_relative_line() с параметрами
- Состояние кнопок перед каждым событием
- Расчет дельт и пропуски событий
- Результаты отправки событий

### 3. УЛУЧШЕННАЯ ЛОГИКА ВОСПРОИЗВЕДЕНИЯ
- Более надежная проверка состояния RMB
- Детальное логирование состояния pressed_buttons
- Проверка корректности расчета дельт

## ИНСТРУКЦИЯ ПО ТЕСТИРОВАНИЮ:

### Шаг 1: Тест функции send_relative_line в изоляции
```bash
python test_send_relative_line.py
```
Наблюдайте за движением курсора. Если курсор двигается плавно - функция работает.

### Шаг 2: Запись простого RMB drag макроса
1. Запустите основное приложение: `python "imba s kameroy.py"`
2. Нажмите "старт(aladayngay❤️)" для начала записи
3. Выполните ПРОСТОЕ движение:
   - Зажмите правую кнопку мыши (ПКМ)
   - Двиньте мышь ровно на 50 пикселей вправо
   - Отпустите ПКМ
4. Нажмите "стоп" для остановки записи
5. Сохраните макрос под именем "test_rmb"

### Шаг 3: Анализ записанного макроса
```bash
python analyze_macro.py
```
Проверьте что:
- Есть 1 событие RMB press
- Есть 1 событие RMB release  
- Между ними есть mouse_move события
- Для движения камеры записываются события `mouse_move_relative` с дельтами (dx, dy)
- Временные интервалы реалистичные

### Шаг 4: Воспроизведение с логированием
1. В основном приложении выберите макрос "test_rmb"
2. Нажмите "Воспроизвести"
3. Наблюдайте за логами в окне приложения
4. Ищите сообщения:
   - `[RMB PRESS DEBUG]` - должно показать инициализацию
   - `[MOVE DEBUG]` - должно показать движения
   - `[RMB CHECK]` - должно показать RMB pressed: True
   - `[DELTA DEBUG]` - должно показать расчет дельт
   - `[SEND DEBUG]` - должно показать вызовы send_relative_line
   - `[SEND_RELATIVE]` - должно показать отправку событий

### Шаг 5: Проверка в игре
1. Запустите Roblox
2. Включите ShiftLock если нужно
3. Запустите воспроизведение макроса
4. Наблюдайте за движением камеры

## ЧТО ИЩЕМ В ЛОГАХ:

### НОРМАЛЬНАЯ РАБОТА:
```
[RMB PRESS DEBUG] RMB pressed at: (100, 200), rmb_center=(100, 200), last_mouse_pos=(100, 200)
[MOVE DEBUG] pos(101,200) RMB=True rmb_center=(100, 200) last_pos=(100, 200)
[RMB CHECK] RMB pressed: True, rmb_center: (100, 200)
[DELTA DEBUG] Calculated: prev(100,200) curr(101,200) = delta(1,0) gain=1.0
[SEND DEBUG] Calling send_relative_line(1, 0)
[SEND_RELATIVE] Called with dx=1, dy=1
[SEND_RELATIVE] Step 1/1: (1,0)
[SEND_RELATIVE] Completed: total delta=(1,0) in 1 steps
```

### ПРОБЛЕМЫ:
- Если `RMB pressed: False` - проблема с отслеживанием кнопок
- Если `last_mouse_pos is None` - проблема с инициализацией
- Если нет `[SEND_RELATIVE]` сообщений - проблема с расчетом дельт
- Если есть сообщения но камера не двигается - проблема в send_relative_line

## ВОЗМОЖНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ:

### Проблема 1: send_relative_line не работает
**Симптомы**: Логи показывают вызовы функции, но мышь не двигается
**Решение**: Пробовать другие API:
- Раскомментировать старую SendInput версию
- Использовать DirectInput
- Использовать SetCursorPos + GetCursorPos

### Проблема 2: Состояние RMB не отслеживается
**Симптомы**: В логах `RMB pressed: False` во время drag
**Решение**: Проверить логику pressed_buttons и сравнение объектов

### Проблема 3: Дельты рассчитываются неверно
**Симптомы**: В логах нулевые или неправильные дельты
**Решение**: Проверить логику last_mouse_pos и расчета

### Проблема 4: Слишком быстрая отправка событий
**Симптомы**: Камера дергается или не успевает обрабатывать
**Решение**: Увеличить задержки в send_relative_line

## ЗАПУСК ТЕСТОВ:

```bash
# Тест функции отправки
python test_send_relative_line.py

# Анализ макросов
python analyze_macro.py

# Основное приложение
python "imba s kameroy.py"
```

## ОЖИДАЕМЫЙ РЕЗУЛЬТАТ:
После этих изменений RMB drag должен работать корректно:
- Плавное движение камеры при воспроизведении
- Отсутствие тряски экрана
- Точное повторение записанных движений
- Детальные логи для диагностики